<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Lua Module 实践 · Pan's paper</title><meta name="description" content="Lua Module 实践 - Zhang pan"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="http://fonts.useso.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">Lua Module 实践</h1><div class="post-info">May 20, 2016</div><div class="post-content"><p>最近用openresty写接口，每个接口都要要链接数据库，写一个通用的模块来实现，顺便学习下lua module的相关知识。</p>
<a id="more"></a>
<h3 id="lua-模块"><a href="#lua-模块" class="headerlink" title="lua 模块"></a>lua 模块</h3><p>Lua中的一个模块就是一个table，table元素包括变量，函数等。“因此创建一个模块很简单，就是创建一个 table，然后把需要导出的常量、函数放入其中，最后返回这个 table”。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 文件名为 module.lua</span></span><br><span class="line"><span class="comment">-- 定义一个名为 module 的模块</span></span><br><span class="line"><span class="built_in">module</span> = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 定义一个常量</span></span><br><span class="line"><span class="built_in">module</span>.constant = <span class="string">"这是一个常量"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 定义一个函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">module.func1</span><span class="params">()</span></span></span><br><span class="line">    <span class="built_in">io</span>.write(<span class="string">"这是一个公有函数！\n"</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">func2</span><span class="params">()</span></span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"这是一个私有函数！"</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">module.func3</span><span class="params">()</span></span></span><br><span class="line">    func2()</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="built_in">module</span></span><br></pre></td></tr></table></figure>
<h4 id="require函数"><a href="#require函数" class="headerlink" title="require函数"></a>require函数</h4><p>require函数用来加载模块。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">"&lt;模块名&gt;"</span>)</span><br><span class="line"><span class="comment">-- 或</span></span><br><span class="line"><span class="built_in">require</span><span class="string">"&lt;模块名&gt;"</span></span><br></pre></td></tr></table></figure>
<p>也可以给模块一个别名，方便调用</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> m = <span class="built_in">require</span>(<span class="string">"module"</span>)</span><br><span class="line"></span><br><span class="line">m.func1</span><br></pre></td></tr></table></figure>
<h4 id="加载机制"><a href="#加载机制" class="headerlink" title="加载机制"></a>加载机制</h4><p>对于我们自定义的模块，并不是放在那个目录都行，require有一套自己的文件加载机制。</p>
<blockquote>
<p>require 用于搜索 Lua 文件的路径是存放在全局变量 package.path 中，当 Lua 启动后，会以环境变量 LUA_PATH 的值来初始这个环境变量。如果没有找到该环境变量，则使用一个编译时定义的默认路径来初始化。</p>
</blockquote>
<p>如果我们设置LUA_PATH环境变量（参考1）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#LUA_PATH</span></span><br><span class="line"><span class="built_in">export</span> LUA_PATH=<span class="string">"~/lua/?.lua"</span></span><br></pre></td></tr></table></figure>
<p>那么调用 require(“module”) 时就会尝试打开以下文件目录去搜索目标。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/Users/dengjoe/lua/module.lua;</span><br><span class="line">./module.lua</span><br><span class="line">/usr/local/share/lua/5.1/module.lua</span><br><span class="line">/usr/local/share/lua/5.1/module/init.lua</span><br><span class="line">/usr/local/lib/lua/5.1/module.lua</span><br><span class="line">/usr/local/lib/lua/5.1/module/init.lua</span><br></pre></td></tr></table></figure>
<h3 id="openresty-实践"><a href="#openresty-实践" class="headerlink" title="openresty 实践"></a>openresty 实践</h3><p>写一个链接数据库的module</p>
<h4 id="设置module路径"><a href="#设置module路径" class="headerlink" title="设置module路径"></a>设置module路径</h4><p>在openresty中设置module路径的方式：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lua_package_path <span class="string">'lua/?.lua;/Users/zhangpan/Project/XinanServer/XinanServer/lua/module/?.lua;;'</span>;</span><br></pre></td></tr></table></figure>
<p>其中<code>lua/?.lua;</code> 代表的绝对路径是 <code>~/lua/?.lua;</code>；后面一个是绝对路径。</p>
<h4 id="设计module"><a href="#设计module" class="headerlink" title="设计module"></a>设计module</h4><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">xinandb = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建数据库链接实例</span></span><br><span class="line"><span class="keyword">local</span> mysql = <span class="built_in">require</span> <span class="string">"resty.mysql"</span></span><br><span class="line"></span><br><span class="line">xinandb.db = mysql:new()</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 连接数据库</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">xinandb.connect</span><span class="params">()</span></span></span><br><span class="line">     <span class="keyword">if</span> <span class="keyword">not</span> xinandb.db <span class="keyword">then</span></span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">false</span></span><br><span class="line">     <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">     <span class="keyword">local</span> ok, err, errno, sqlstate = (xinandb.db):connect &#123;</span><br><span class="line">                    host = <span class="string">"127.0.0.1"</span>,</span><br><span class="line">                    port = <span class="number">3306</span>,</span><br><span class="line">                    database = <span class="string">"xinan"</span>,</span><br><span class="line">                    user = <span class="string">"***"</span>,</span><br><span class="line">                    password = <span class="string">"***"</span>,</span><br><span class="line">                    max_packet_size = <span class="number">1024</span> * <span class="number">1024</span> &#125;</span><br><span class="line">     <span class="keyword">return</span> ok               </span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> xinandb</span><br></pre></td></tr></table></figure>
<h4 id="yield"><a href="#yield" class="headerlink" title="yield"></a>yield</h4><p>这里遇到的一个问题：开始想创建db时就直接链接</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">xinandb.db = mysql:new()</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> ok, err, errno, sqlstate = (xinandb.db):connect &#123;</span><br><span class="line">                    host = <span class="string">"127.0.0.1"</span>,</span><br><span class="line">                    port = <span class="number">3306</span>,</span><br><span class="line">                    database = <span class="string">"xinan"</span>,</span><br><span class="line">                    user = <span class="string">"***"</span>,</span><br><span class="line">                    password = <span class="string">"***"</span>,</span><br><span class="line">                    max_packet_size = <span class="number">1024</span> * <span class="number">1024</span> &#125;</span><br></pre></td></tr></table></figure>
<p>这样就会报一个错误</p>
<blockquote>
<p>[error] 7091#0: *291 lua entry thread aborted: runtime error: attempt to yield across C-call boundary</p>
</blockquote>
<p>最终参考文章<a href="https://orchina.org/topic/50/view" target="_blank" rel="external">关于在config.lua中加入resolver包，出现跨界问题</a>解决。</p>
<p>解决方式：把连接数据库操作封装在一个函数中供调用。</p>
<h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><p>使用就比较简单了，和其他一样</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 连接DB</span></span><br><span class="line"><span class="keyword">local</span> xinandb = <span class="built_in">require</span>(<span class="string">"xinandb"</span>)</span><br><span class="line"><span class="keyword">local</span> res = xinandb:connect()</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> res <span class="keyword">then</span></span><br><span class="line">	ngx.say(<span class="string">"&#123;\"errorCode\" : 1003, \"errorMessage\" : \"连接数据库错误\"&#125;"</span>)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">local</span> db = xinandb.db;</span><br></pre></td></tr></table></figure>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><h4 id="参考1：设置环境变量的方式："><a href="#参考1：设置环境变量的方式：" class="headerlink" title="参考1：设置环境变量的方式："></a>参考1：设置环境变量的方式：</h4><blockquote>
<p>如果没有 LUA_PATH 这个环境变量，也可以自定义设置，在当前用户根目录下打开 .profile文件（没有则创建，打开 .bashrc 文件也可以），例如把 “~/lua/“ 路径加入 LUA_PATH 环境变量里;</p>
</blockquote>
<p>然后执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> ~/.profile</span><br></pre></td></tr></table></figure>
<h4 id="坑：再次打开终端环境变量失效"><a href="#坑：再次打开终端环境变量失效" class="headerlink" title="坑：再次打开终端环境变量失效"></a>坑：再次打开终端环境变量失效</h4><p>用的是Mac系统，shell是zsh。按照上面的方式设置了环境变量后，关闭终端，再次打开后环境变量就失效了。</p>
<p>解决方式：将LUA_PATH添加到.zshrc 执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> ~/.zshrc</span><br></pre></td></tr></table></figure></div></article></div></section><footer><div class="paginator"><a href="/2016/05/05/rsa-sercurity-2/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2016 <a href="http://yoursite.com">Zhang pan</a>, unless otherwise noted.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>